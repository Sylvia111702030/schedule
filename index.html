<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>AR 時間表 Demo</title>
  <!-- 引入 A-Frame 與 AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <!-- 引入 Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1em; }
    select, input[type="text"] { margin-right: 1em; }
    #result { background: #f0f0f0; padding: 1em; margin-top: 1em; white-space: pre-wrap; }
    table { border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    #reader { margin-top: 1em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>AR 時間表 Demo</h2>
  <div id="tip">請將你的牌卡對準鏡頭，僅會顯示自己的時間表</div>

  <!-- AR 場景 -->
  <a-scene embedded arjs>
    <a-marker type="pattern" url="pattern-IMG_0100.patt" id="mylogo-marker">
      <a-entity id="scheduleText-mylogo" position="0 0.5 0" text="value: 載入中...; color: #333; align: center; width: 4"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- 行程填寫表單 -->
  <div>
    <label>
      星期：
      <select id="weekday">
        <option value="Monday">星期一</option>
        <option value="Tuesday">星期二</option>
        <option value="Wednesday">星期三</option>
        <option value="Thursday">星期四</option>
        <option value="Friday">星期五</option>
      </select>
    </label>
    <label>
      時段：
      <select id="time_slot">
        <option value="8-10">8-10</option>
        <option value="10-12">10-12</option>
        <option value="12-14">12-14</option>
        <option value="14-16">14-16</option>
        <option value="16-18">16-18</option>
        <option value="18-20">18-20</option>
      </select>
    </label>
    <label>
      活動：
      <input id="activity" value="上課">
    </label>
    <button onclick="saveSchedule()">儲存時段</button>
    <button onclick="getMySchedule()">查詢我的時間表</button>
    <button onclick="getAvailableUsers()">查詢此時段有空的人</button>
    <div id="result"></div>
    <table id="schedule_table" style="display:none;">
      <thead>
        <tr>
          <th>星期</th>
          <th>時段</th>
          <th>活動</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <hr>
    <button onclick="endGame()" style="color:red;">結束遊戲（清除本場所有資料）</button>
    <div id="end_result"></div>
  </div>

  <script>
    // Supabase 設定
    const supabaseUrl = 'https://your-supabase-url.supabase.co';
    const supabaseKey = 'your-supabase-key';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const markerUserMap = {
      'mylogo-marker': 'player1',
    };
    const markerTextMap = {
      'mylogo-marker': 'scheduleText-mylogo',
    };

    // 取得本地 game_id
    let game_id = localStorage.getItem('game_id');
    if (!game_id) {
      game_id = prompt('請輸入本場遊戲ID（game_id）');
      if (game_id) localStorage.setItem('game_id', game_id);
    }

    // 時間表顯示格式
    function formatScheduleTable(data) {
      if (!data || data.length === 0) return '查無時間表';
      // 依 weekday, time_slot 排序
      const weekOrder = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
      const slotOrder = ['8-10','10-12','12-14','14-16','16-18','18-20'];
      data.sort((a, b) => {
        const w1 = weekOrder.indexOf(a.weekday), w2 = weekOrder.indexOf(b.weekday);
        if (w1 !== w2) return w1 - w2;
        return slotOrder.indexOf(a.time_slot) - slotOrder.indexOf(b.time_slot);
      });
      // 組合文字
      let result = '';
      let lastWeek = '';
      data.forEach(row => {
        if (row.weekday !== lastWeek) {
          result += `\n${row.weekday}:\n`;
          lastWeek = row.weekday;
        }
        result += `  ${row.time_slot}: ${row.activity}\n`;
      });
      return result.trim();
    }

    // 監聽所有 marker
    Object.keys(markerUserMap).forEach(markerId => {
      const marker = document.getElementById(markerId);
      const textEntityId = markerTextMap[markerId];
      marker.addEventListener('markerFound', async function () {
        const user_id = markerUserMap[markerId];
        if (!user_id) {
          document.getElementById(textEntityId).setAttribute('text', 'value: 未對應玩家; color: #FF0000; align: center; width: 4');
          return;
        }
        const { data, error } = await supabase
          .from('schedules')
          .select('weekday, time_slot, activity')
          .eq('game_id', game_id)
          .eq('user_id', user_id);
        const text = formatScheduleTable(data);
        document.getElementById(textEntityId).setAttribute('text', 'value', text);
      });
    });

    // 儲存一筆時段活動
    async function saveSchedule() {
      const weekday = document.getElementById('weekday').value;
      const time_slot = document.getElementById('time_slot').value;
      const activity = document.getElementById('activity').value.trim();
      const user_id = prompt('請輸入你的使用者ID（如：playerA）');
      if (!user_id || !game_id || !weekday || !time_slot || !activity) {
        document.getElementById('result').innerText = '請填寫所有欄位！';
        return;
      }
      // 先檢查是否已存在，存在則更新
      const { data: exist } = await supabase
        .from('schedules')
        .select('id')
        .eq('game_id', game_id)
        .eq('user_id', user_id)
        .eq('weekday', weekday)
        .eq('time_slot', time_slot)
        .single();
      let res;
      if (exist && exist.id) {
        res = await supabase
          .from('schedules')
          .update({ activity })
          .eq('id', exist.id);
      } else {
        res = await supabase
          .from('schedules')
          .insert([{ game_id, user_id, weekday, time_slot, activity }]);
      }
      if (res.error) {
        document.getElementById('result').innerText = '儲存失敗: ' + res.error.message;
      } else {
        document.getElementById('result').innerText = '儲存成功！';
        getMySchedule();
      }
    }

    // 查詢自己的所有時段
    async function getMySchedule() {
      const user_id = prompt('請輸入你的使用者ID（如：playerA）');
      const { data, error } = await supabase
        .from('schedules')
        .select('weekday, time_slot, activity')
        .eq('game_id', game_id)
        .eq('user_id', user_id)
        .order('weekday', { ascending: true })
        .order
::contentReference[oaicite:16]{index=16}
