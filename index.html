<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>虛實整合遊戲 Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1em; }
    select, input[type="text"] { margin-right: 1em; }
    #result { background: #f0f0f0; padding: 1em; margin-top: 1em; white-space: pre-wrap; }
    table { border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    #reader { margin-top: 1em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>虛實整合遊戲 Demo</h2>
  <div id="step1">
    <button onclick="startScan()">掃描牌卡（取得ID）</button>
    <div id="reader" class="hidden"></div>
    <div id="scan_result"></div>
  </div>
  <div id="step2" class="hidden">
    <div>你的ID：<span id="user_id"></span></div>
    <div>本場遊戲ID：<span id="game_id"></span></div>
    <button onclick="showRole()">查詢我的身份</button>
    <div id="role_result"></div>
    <hr>
    <label>
      星期：
      <select id="weekday">
        <option value="Monday">星期一</option>
        <option value="Tuesday">星期二</option>
        <option value="Wednesday">星期三</option>
        <option value="Thursday">星期四</option>
        <option value="Friday">星期五</option>
      </select>
    </label>
    <label>
      時段：
      <select id="time_slot">
        <option value="8-10">8-10</option>
        <option value="10-12">10-12</option>
        <option value="12-14">12-14</option>
        <option value="14-16">14-16</option>
        <option value="16-18">16-18</option>
        <option value="18-20">18-20</option>
      </select>
    </label>
    <label>
      活動：
      <input id="activity" value="上課">
    </label>
    <button onclick="saveSchedule()">儲存時段</button>
    <button onclick="getMySchedule()">查詢我的時間表</button>
    <button onclick="getAvailableUsers()">查詢此時段有空的人</button>
    <div id="result"></div>
    <table id="schedule_table" style="display:none;">
      <thead>
        <tr>
          <th>星期</th>
          <th>時段</th>
          <th>活動</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <hr>
    <button onclick="endGame()" style="color:red;">結束遊戲（清除本場所有資料）</button>
    <div id="end_result"></div>
  </div>
  <script>
    // Supabase 設定
    const supabaseUrl = 'https://zjbhnljmhaqkytobiogm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqYmhubGptaGFxa3l0b2Jpb2dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwMjk4OTcsImV4cCI6MjA2MjYwNTg5N30.XOYi3FbhCr9Y1g2svklXQW3SUxKiCgf1iTI5ueUrNao';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // UUID 產生器
    function generateUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    // 掃描牌卡
    let scanned_id = null;
    let game_id = localStorage.getItem('game_id');
    let user_id = null;

    function startScan() {
      document.getElementById('reader').classList.remove('hidden');
      document.getElementById('scan_result').innerText = '';
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText, decodedResult) => {
          html5QrCode.stop();
          document.getElementById('reader').classList.add('hidden');
          scanned_id = decodedText;
          user_id = scanned_id;
          document.getElementById('scan_result').innerText = '掃描成功，ID：' + user_id;
          afterScan();
        }
      );
    }

    async function afterScan() {
      // 若本地沒有 game_id，產生新 game_id
      game_id = localStorage.getItem('game_id');
      if (!game_id) {
        game_id = generateUUID();
        localStorage.setItem('game_id', game_id);
        alert('已建立新遊戲，game_id：' + game_id + '\\n請讓其他玩家掃描並加入本場遊戲');
        // 分配身份
        await assignRoles(game_id, [user_id]);
      } else {
        // 若已分配身份，直接查詢
        const { data: exist } = await supabase
          .from('roles')
          .select('user_id')
          .eq('game_id', game_id);
        // 若還沒分配滿5人，加入身份分配
        if (exist.length < 5 && !exist.some(r => r.user_id === user_id)) {
          const all_ids = exist.map(r => r.user_id).concat([user_id]);
          await assignRoles(game_id, all_ids);
        }
      }
      document.getElementById('user_id').innerText = user_id;
      document.getElementById('game_id').innerText = game_id;
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
    }

    // 分配身份（1反派4正派，隨機分配，已存在的不變）
    async function assignRoles(game_id, user_ids) {
      // 先查詢已分配的
      const { data: exist } = await supabase
        .from('roles')
        .select('user_id, role')
        .eq('game_id', game_id);
      const assigned = exist.map(r => r.user_id);
      const to_assign = user_ids.filter(id => !assigned.includes(id));
      // 若已分配5人，直接回傳
      if (exist.length >= 5) return;
      // 分配剩下的身份
      let roles = [];
      if (exist.length === 0) {
        // 第一次分配，隨機一人反派
        const shuffled = user_ids.sort(() => Math.random() - 0.5);
        roles = shuffled.map((id, idx) => ({
          user_id: id,
          role: idx === 0 ? '反派' : '正派',
          game_id
        }));
      } else {
        // 已有分配，剩下的都給正派
        roles = to_assign.map(id => ({
          user_id: id,
          role: '正派',
          game_id
        }));
      }
      if (roles.length > 0) {
        await supabase.from('roles').insert(roles);
      }
    }

    // 查詢自己的身份
    async function showRole() {
      const { data, error } = await supabase
        .from('roles')
        .select('role')
        .eq('game_id', game_id)
        .eq('user_id', user_id)
        .single();
      if (data) {
        document.getElementById('role_result').innerText = '你的身份是：' + data.role;
      } else {
        document.getElementById('role_result').innerText = '查無身份，請聯絡管理員';
      }
    }

    // 儲存一筆時段活動
    async function saveSchedule() {
      const weekday = document.getElementById('weekday').value;
      const time_slot = document.getElementById('time_slot').value;
      const activity = document.getElementById('activity').value.trim();
      if (!user_id || !game_id || !weekday || !time_slot || !activity) {
        document.getElementById('result').innerText = '請填寫所有欄位！';
        return;
      }
      // 先檢查是否已存在，存在則更新
      const { data: exist } = await supabase
        .from('schedules')
        .select('id')
        .eq('game_id', game_id)
        .eq('user_id', user_id)
        .eq('weekday', weekday)
        .eq('time_slot', time_slot)
        .single();
      let res;
      if (exist && exist.id) {
        res = await supabase
          .from('schedules')
          .update({ activity })
          .eq('id', exist.id);
      } else {
        res = await supabase
          .from('schedules')
          .insert([{ game_id, user_id, weekday, time_slot, activity }]);
      }
      if (res.error) {
        document.getElementById('result').innerText = '儲存失敗: ' + res.error.message;
      } else {
        document.getElementById('result').innerText = '儲存成功！';
        getMySchedule();
      }
    }

    // 查詢自己的所有時段
    async function getMySchedule() {
      const { data, error } = await supabase
        .from('schedules')
        .select('weekday, time_slot, activity')
        .eq('game_id', game_id)
        .eq('user_id', user_id)
        .order('weekday', { ascending: true })
        .order('time_slot', { ascending: true });
      if (error) {
        document.getElementById('result').innerText = '查詢失敗: ' + error.message;
        document.getElementById('schedule_table').style.display = 'none';
      } else if (data && data.length > 0) {
        let tbody = '';
        data.forEach(row => {
          tbody += `<tr><td>${row.weekday}</td><td>${row.time_slot}</td><td>${row.activity}</td></tr>`;
        });
        document.querySelector('#schedule_table tbody').innerHTML = tbody;
        document.getElementById('schedule_table').style.display = '';
        document.getElementById('result').innerText = '';
      } else {
        document.getElementById('result').innerText = '查無資料';
        document.getElementById('schedule_table').style.display = 'none';
      }
    }

    // 查詢某時段有空的人
    async function getAvailableUsers() {
      const weekday = document.getElementById('weekday').value;
      const time_slot = document.getElementById('time_slot').value;
      const { data, error } = await supabase
        .from('schedules')
        .select('user_id, activity')
        .eq('game_id', game_id)
        .eq('weekday', weekday)
        .eq('time_slot', time_slot)
        .eq('activity', '空閒');
      if (error) {
        document.getElementById('result').innerText = '查詢失敗: ' + error.message;
      } else if (data && data.length > 0) {
        const users = data.map(row => row.user_id).join(', ');
        document.getElementById('result').innerText = `在 ${weekday} ${time_slot} 有空的人：\n${users}`;
      } else {
        document.getElementById('result').innerText = `在 ${weekday} ${time_slot} 沒有人標記為空閒`;
      }
    }

    // 結束遊戲（清除所有資料）
    async function endGame() {
      if (!game_id) {
        document.getElementById('end_result').innerText = '尚未建立遊戲';
        return;
      }
      await supabase.from('roles').delete().eq('game_id', game_id);
      await supabase.from('schedules').delete().eq('game_id', game_id);
      localStorage.removeItem('game_id');
      document.getElementById('end_result').innerText = '本場遊戲資料已清除！請重新整理頁面開始新遊戲。';
      setTimeout(() => location.reload(), 2000);
    }
  </script>
</body>
</html>
